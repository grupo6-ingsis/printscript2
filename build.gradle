ext {
    versionCode = '1.2.3'
}

allprojects {
    version = rootProject.ext.versionCode
}
tasks.register('bumpVersion') {
    doLast {
        def file = rootProject.file('build.gradle')
        def text = file.text
        def matcher = (text =~ /versionCode = '(\d+)\.(\d+)\.(\d+)'/)
        if (matcher.find()) {
            def major = matcher.group(1).toInteger()
            def minor = matcher.group(2).toInteger()
            def patch = matcher.group(3).toInteger() + 1
            def newVersion = "${major}.${minor}.${patch}"
            def newText = text.replaceFirst(/versionCode = '.*'/, "versionCode = '${newVersion}'")
            file.text = newText
            println "Versión actualizada a ${newVersion}"
        } else {
            throw new GradleException("No se encontró versionCode en build.gradle")
        }
    }
}

subprojects {
    tasks.matching { it.name == 'publish' }.configureEach {
        dependsOn rootProject.tasks.named('bumpVersion')
    }
}
